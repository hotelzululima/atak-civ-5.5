
package com.atak.plugins.impl;

import android.content.Context;
import android.content.pm.PackageInfo;
import android.content.pm.PackageManager;
import android.content.pm.Signature;

public class SystemPluginValidator {

    // subset of the acceptable keys for generalized plugins
    private static final String[] ACCEPTABLE_KEY_LIST = {
            "30820613308203fba00302010202144aec2ed8a9712e8901bd89a4c270abf5768ee0f3300d06092a864886f70d01010b0500308197310b30090603550406130255533111300f06035504080c0856697267696e69613115301306035504070c0c466f72742042656c766f6972310c300a060355040a0c0354414b31173015060355040b0c0e50726f647563742043656e7465723137303506035504030c2e54414b2050726f647563742043656e746572204154414b20547275737465642042756e646c652052656c656173653020170d3232303231363232313033345a180f32303532303230393232313033345a308197310b30090603550406130255533111300f06035504080c0856697267696e69613115301306035504070c0c466f72742042656c766f6972310c300a060355040a0c0354414b31173015060355040b0c0e50726f647563742043656e7465723137303506035504030c2e54414b2050726f647563742043656e746572204154414b20547275737465642042756e646c652052656c6561736530820222300d06092a864886f70d01010105000382020f003082020a0282020100d1b8096cf83b498493ea982354d822d8f31677317e8bfe9802bf22a633c139a61668aae4ee3a71a981b0978697b4d8438856820dfe86cce97d6f123c72a19e28dac1457d12652e3209670b7680c7dd6136eef71411a32f058b1c5ea717b6fc1b820218a8cb55d56595d1eaa1714b4ebfb939c9e1450fce186be162a272684b38b49458ce80c9f2b547f6d39734dff32dc55449b992d252e0af911c78fb3251730cb5c35daff74b77c56bd97a0a4251678aeb618f3689cbc53ba8ea7bff60b9e9a0f288d668d50546dc8a9e3322f4d6d16bb204f939848a2c8307c9228271730d96474feea1016d939f4094690e4d520839e4d74800ae9e28c42032d2ba9f7128f8c48de18c9581a9cfad5b62b2eac44ea77cf24750c74964c4be91f073ceb09142662a69178f379f78e30ff80b7e1aa0378d73c13a94573f8f66a47bd22d02a27538a4155032a07f8321938f38986aa15361acf320a22e6c5657e611e314e3029e48f92094fbe6b2abe5ddc86bdb6f071e898c53d95c755c9985c2e7da341d75963198b1eeb9f2bfa0f6a6add03091ec4ce10f34d0bc23593b3478cd9b4f42f863f998c5fd34e69facd2793ce6fa1463a3d40b117905de53c2729b56ff2c12d3647487fe60f4afcfa21f8f1a70d2d13795db7823c374f70073410bd46f187081d95a92fbfaeb9f0502b97b20e16201d48341dc0520a06029014376f9325bc22d0203010001a3533051301d0603551d0e041604149cda2e93cb9d6395b13a739e6f630a609ea37369301f0603551d230418301680149cda2e93cb9d6395b13a739e6f630a609ea37369300f0603551d130101ff040530030101ff300d06092a864886f70d01010b0500038202010056666b2320bac33947f2edc1e494cacfb4187e42a4c970a0d549ac7960963c3c421208815cb00b089ce74c1e28fbd9623b90f8ebbe5c08f09f96033c76c7056473c67b55657d3027196f0eb44740fb6b40dcabd3d83485186cabd8257248ea7f391ccdec75c09a949393476467bbe82fb5daf45b7bdf12434e3bf3d310c3ef1fa6e7c9273aadef78e79883d5d422c879b774542d84a4dbfbed9428a430c5b906ca1ea02c91a9145deed620a949353fe17cf6553d394fdb2ec9944b33a42a8bbe795a7a42a5c47d68425739b373587232666d99217fc5e5dd2ff5afd83b8944667b406b22cd317e7e9d0a0c428af2777daa341b58421d058ba45e3bc1cca188b7382767df1f22f9765ad659472913dc731d3df659362043f214e2de41c802863b8ae64051cebca19aaad09f33ec21c58a51aa565208d3fc5c8fea91f1d2d0ebbc391a6ae2fef1930940a701078614d98a6712371455d4765bbe7f94d078965669beab6c8dcdd4971a1d69defe26db90c648df4e81a777cc56b81709b73d6227cce602843f38e5c01483888216ad067a87c2834e14eb2a9301e5d31db3a800cfb3d95d7bc11d3bdda3bf9415066df727b7fb822a5f0dbb668690984a4140fc886b61253544c2905ccbea05991ec45640bcbc099bb03c8cb2d031f3deacd1f80903be7322457e27ed7f8f0580df7da8a6929a18a3807b9542a99451f8b2089ce303"
    };

    /**
     * Strict checking of the app transparency signature for the system plugin.
     * @param context the context to use
     * @param pkgname the system plugin name
     * @return true if the app contains a valid inner signature
     */
    public static boolean checkAppTransparencySignature(final Context context,
            String pkgname) {
        return PluginValidator.checkAppTransparencySignature(context, pkgname,
                ACCEPTABLE_KEY_LIST);
    }

    /**
     * Checks to see if the pkgname signature provided matches the core signature
     * @param pkgname the package name
     * @return true if the key is the same
     */
    public static boolean checkCoreSignature(Context context, String pkgname) {
        final String core = "3082038b30820273a0030201020204555862e5300d06092a864886f70d01010b05003076310b30090603550406130255533110300e06035504081307556e6b6e6f776e3110300e06035504071307556e6b6e6f776e311f301d060355040a13164154414b20446576656c6f706d656e742047726f75703110300e060355040b1307556e6b6e6f776e3110300e06035504031307556e6b6e6f776e301e170d3134303131303135333233355a170d3431303532383135333233355a3076310b30090603550406130255533110300e06035504081307556e6b6e6f776e3110300e06035504071307556e6b6e6f776e311f301d060355040a13164154414b20446576656c6f706d656e742047726f75703110300e060355040b1307556e6b6e6f776e3110300e06035504031307556e6b6e6f776e30820122300d06092a864886f70d01010105000382010f003082010a0282010100f0f45336437a032e04c3315d6f73a23d0c7cc5eebe2054dcac3bc6805cf9289d6d066f542fb48e70577e9151b7821ff47eeac89435aac62bada421baa2b6c92e4e55ddf5878135f75b792fc6dd8b974d873faed80c5d926af2155a5d07c160e3a07bccbf2be514f2dae83782830b6333c29e898464acccd8185687e91331247d346862b420418099e921a7b6e69c358b9cf21b52cd17356562d477358538a479c237aca6445132436f8915b17bcb69edbf6ae8a3911bb41f4930dc4247ff350a2a53cbe55e4bc53d812ca0221bcf14d95854c4e9b19ecd42386bd736ae137a4a24ffaf6cddb06be73b1abcf9d07ac6f3e14dbd5d5a8bad4f0a3f9f2a1e0b67810203010001a321301f301d0603551d0e04160414ea99165dfa01ec852de12b5bf14a6c454d693f1b300d06092a864886f70d01010b050003820101005fc44210bdcfb16fb91185374a7712b0b4635338bbeeb42c1e6a49dd3af54763e488ba851a7befaefeeefddae83428c153e3e595ed4d72bb00e4db09231a7e41454133e4b984c82a55a07a53d64a49e5d1524864fc960006f0c610a94dce8067024aa27d8aa27654443f55f5b5a1613ccb30a8960236a579a9ca05cb02aaaa3e05e923c5b60a2b6d55b99c5bd0a001bb13e0c413223ed5be82fcbfeb176776b60c5aa171cfe2047d663379effc0bda3e881edfe7e0b5773b2cb90d6e9db8c1abc6ffa8324b0973e9fab9a61d1b0cb1be4d2b5a9a6b5cd5551fdd80d922f8d1b0ddbb00c884f3a54dbb32fbe7d20ca19ee19a90a6d91beac12834628e014914f0";

        try {
            final PackageManager pm = context.getPackageManager();
            final PackageInfo atak = pm.getPackageInfo(context.getPackageName(),
                    PackageManager.GET_SIGNATURES);

            final PackageInfo pi = pm.getPackageInfo(pkgname,
                    PackageManager.GET_SIGNATURES);

            if (pi != null && pi.signatures != null) {
                for (final Signature sig : pi.signatures) {
                    if (core.equals(sig.toCharsString()))
                        return true;
                }
            }
        } catch (Exception ignored) {
        }

        return false;
    }

}
