name: Release SDK (no LFS)

on:
  workflow_dispatch:
    inputs:
      release_tag:
        description: "Tag/label to use in the artifact name (e.g., 5.5.1.8)"
        required: true
        default: local
      ref:
        description: "Git ref to build (branch, tag, or commit). Leave blank for default."
        required: false
        default: ""
  release:
    types: [created]

jobs:
  assemble:
    name: Build
    runs-on: ubuntu-latest
    # Exact parity with the original CI runtime
    container:
      image: openjdk:8-jdk
    defaults:
      run:
        shell: bash

    env:
      # Defaults match the 4.6 workflow but can be overridden by the repoâ€™s Gradle config
      ANDROID_COMPILE_SDK: 29
      ANDROID_BUILD_TOOLS: 29.0.3
      ANDROID_SDK_TOOLS: 4333796
      NDK_VERSION: 12b
      # when manually triggered, prefer the provided tag/ref
      RELEASE_TAG: ${{ inputs.release_tag || github.ref_name }}
      TARGET_REF: ${{ inputs.ref }}

    steps:
      - name: Checkout repository (no LFS)
        uses: actions/checkout@v4
        with:
          lfs: false
          fetch-depth: 0
          ref: ${{ env.TARGET_REF || github.ref }}

      - name: Fail fast if any Git LFS pointer files exist
        run: |
          if grep -RIl --exclude-dir=.git -m1 -e '^version https://git-lfs.github.com/spec' . >/dev/null 2>&1; then
            echo "Found Git LFS pointer files, but this workflow is LFS-free. Replace them with real contents or remove LFS tracking."
            exit 1
          fi

      - name: Install base packages
        run: |
          apt-get update
          apt-get -y install ant apg dos2unix autoconf automake g++ libtool patch make \
                             cmake ninja-build swig tclsh zip python3-pip wget unzip xz-utils \
                             curl ca-certificates git jq
          python3 -m pip install -U pip setuptools
          python3 -m pip install conan==1.59.0

      - name: Set Android env defaults
        run: |
          echo "ANDROID_COMPILE_SDK=${ANDROID_COMPILE_SDK}" >> $GITHUB_ENV
          echo "ANDROID_BUILD_TOOLS=${ANDROID_BUILD_TOOLS}" >> $GITHUB_ENV
          echo "ANDROID_SDK_TOOLS=${ANDROID_SDK_TOOLS}" >> $GITHUB_ENV
          echo "NDK_VERSION=${NDK_VERSION}" >> $GITHUB_ENV

      - name: Auto-detect compileSdk/buildTools/ndkVersion from Gradle (best-effort)
        run: |
          set -e
          comp="$(grep -RhoP 'compileSdk(?:Version)?\s+(\d+)' atak/ATAK 2>/dev/null | awk '{print $2}' | tail -1 || true)"
          bt="$(grep -RhoP "buildToolsVersion\s*['\"]([0-9.]+)['\"]" atak/ATAK 2>/dev/null | sed -E "s/.*['\"]([0-9.]+)['\"].*/\1/" | tail -1 || true)"
          ndk="$(grep -RhoP "android\.ndkVersion\s*[=:]\s*['\"]([^'\" ]+)['\"]" . 2>/dev/null | sed -E "s/.*['\"]([^'\" ]+)['\"].*/\1/" | tail -1 || true)"
          [ -n "$comp" ] && echo "ANDROID_COMPILE_SDK=$comp" >> $GITHUB_ENV
          [ -n "$bt" ]   && echo "ANDROID_BUILD_TOOLS=$bt" >> $GITHUB_ENV
          [ -n "$ndk" ]  && echo "NDK_VERSION=$ndk" >> $GITHUB_ENV
          echo "Detected compileSdk=$comp, buildTools=$bt, ndkVersion=$ndk"

      - name: Set up Android SDK
        run: |
          wget -q -O android-sdk.zip "https://dl.google.com/android/repository/sdk-tools-linux-${ANDROID_SDK_TOOLS}.zip"
          unzip -qq -d android-sdk-linux android-sdk.zip
          mkdir -p ~/.android
          : > ~/.android/repositories.cfg
          yes | android-sdk-linux/tools/bin/sdkmanager "platforms;android-${ANDROID_COMPILE_SDK}" >/dev/null
          yes | android-sdk-linux/tools/bin/sdkmanager "platform-tools" >/dev/null
          yes | android-sdk-linux/tools/bin/sdkmanager "build-tools;${ANDROID_BUILD_TOOLS}" >/dev/null
          echo "ANDROID_HOME=$PWD/android-sdk-linux" >> $GITHUB_ENV
          echo "$PWD/android-sdk-linux/platform-tools" >> $GITHUB_PATH
          set +e; yes | android-sdk-linux/tools/bin/sdkmanager --licenses >/dev/null; set -e

      - name: Set up Android NDK
        run: |
          wget -q -O android-ndk.zip "https://dl.google.com/android/repository/android-ndk-r${NDK_VERSION}-linux-x86_64.zip"
          unzip -qq android-ndk.zip
          echo "ANDROID_NDK_HOME=$PWD/android-ndk-r${NDK_VERSION}" >> $GITHUB_ENV
          echo "ANDROID_NDK=$PWD/android-ndk-r${NDK_VERSION}" >> $GITHUB_ENV

      - name: Build dependencies (prebuild.sh) and prune takthirdparty
        run: |
          git submodule update --init --recursive
          pushd scripts
          bash ./prebuild.sh
          popd
          cd takthirdparty
          rm -rf distfiles
          for i in builds/* ; do
            [ -d "$i" ] || continue
            pushd "$i"
            (find * -type d -not -name "include" -not -path "include/*" -not -name "java" -not -name "lib" -not -path "lib/ogdi" -print0 | xargs -0 -I {} rm -rf "{}" || true)
            (find . -maxdepth 1 -type f -print0 | xargs -0 -I {} rm -f "{}" || true)
            (cd lib && (find . -maxdepth 1 -type f -not -name "*.so" -print0 | xargs -0 -I {} rm -f "{}" || true))
            popd
          done

      - name: Set up CMake 3.14.7
        run: |
          wget -q -O cmake-3.14.7.tar.gz https://cmake.org/files/v3.14/cmake-3.14.7-Linux-x86_64.tar.gz
          tar -xzf cmake-3.14.7.tar.gz
          echo "CMAKE_HOME=$PWD/cmake-3.14.7-Linux-x86_64" >> $GITHUB_ENV

      - name: Install keystore (from secrets)
        env:
          ANDROID_KEYSTORE_FILE: ${{ secrets.SDK_KEYSTORE_FILE }}
          ANDROID_KEYSTORE_ALIAS: ${{ secrets.SDK_KEYSTORE_ALIAS }}
          ANDROID_KEYSTORE_STORE_PASSWORD: ${{ secrets.SDK_KEYSTORE_STORE_PASSWORD }}
          ANDROID_KEYSTORE_KEY_PASSWORD: ${{ secrets.SDK_KEYSTORE_KEY_PASSWORD }}
        run: |
          rm -rf $HOME/secrets
          mkdir -p $HOME/secrets
          echo "$ANDROID_KEYSTORE_FILE" > $HOME/secrets/sdk_keystore.base64
          base64 -d $HOME/secrets/sdk_keystore.base64 > $HOME/secrets/sdk_keystore
          cd atak
          rm -f local.properties
          {
            echo "takDebugKeyFile=$HOME/secrets/sdk_keystore"
            echo "takDebugKeyFilePassword=$ANDROID_KEYSTORE_STORE_PASSWORD"
            echo "takDebugKeyAlias=$ANDROID_KEYSTORE_ALIAS"
            echo "takDebugKeyPassword=$ANDROID_KEYSTORE_KEY_PASSWORD"
            echo "takReleaseKeyFile=$HOME/secrets/sdk_keystore"
            echo "takReleaseKeyFilePassword=$ANDROID_KEYSTORE_STORE_PASSWORD"
            echo "takReleaseKeyAlias=$ANDROID_KEYSTORE_ALIAS"
            echo "takReleaseKeyPassword=$ANDROID_KEYSTORE_KEY_PASSWORD"
            echo "cmake.dir=$CMAKE_HOME"
            echo "ndk.dir=$ANDROID_NDK"
          } >> local.properties

      - name: Assemble ATAK APK
        run: |
          cd atak
          rm -rf ATAK/app/build
          bash ./gradlew generateJniHeaders
          bash ./gradlew assembleCivSdk

      - name: Generate ATAK CIV SDK package
        run: |
          rm -rf takthirdparty takengine pluginsdk/
          unzip -qq pluginsdk.zip
          cp ./atak/ATAK/app/build/outputs/apk/civ/sdk/*-sdk.apk ./pluginsdk/atak.apk
          cp ./atak/ATAK/app/build/libs/main.jar ./pluginsdk
          cp ./atak/ATAK/app/src/main/assets/support/license/LICENSE.txt ./pluginsdk
          cp -r ./plugin-examples ./pluginsdk/
          echo "ATAK CIV SDK $(git rev-parse --short HEAD) ($(git show -s --format=%ct))" > pluginsdk/VERSION.txt
          rm -rf javadoc
          mkdir -p tmp/src
          cp -R ./atak/ATAK/app/src/common/java/* tmp/src
          cp -R ./atak/ATAK/app/src/main/java/* tmp/src
          pushd tmp/src
          javadoc -linkoffline http://d.android.com/reference file://$ANDROID_HOME/docs/reference \
            -d ../javadoc -classpath .:$ANDROID_HOME/platforms/android-${ANDROID_COMPILE_SDK}/android.jar \
            -subpackages . &> /dev/null || echo "success by failure"
          popd
          pushd tmp/javadoc
          jar cvf ../../pluginsdk/atak-javadoc.jar . >/dev/null || true
          popd
          pushd atak-gradle-takdev
          chmod 755 gradlew || true
          dos2unix gradlew || true
          ./gradlew jar
          cp ./build/libs/atak-gradle-takdev-*.jar ../pluginsdk/atak-gradle-takdev.jar
          popd
          mv pluginsdk atak-civ
          zip -qq -r "atak-civ-sdk-${RELEASE_TAG}.zip" atak-civ
          rm -rf atak-civ

      # If this workflow is triggered by a Release, upload to that release.
      - name: Publish SDK to Release
        if: github.event_name == 'release'
        uses: actions/upload-release-asset@v1.0.1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ github.event.release.upload_url }}
          asset_path: atak-civ-sdk-${{ env.RELEASE_TAG }}.zip
          asset_name: atak-civ-sdk-${{ env.RELEASE_TAG }}.zip
          asset_content_type: application/zip

      # If run via workflow_dispatch, just keep the artifact
      - name: Upload artifact (manual run)
        if: github.event_name == 'workflow_dispatch'
        uses: actions/upload-artifact@v4
        with:
          name: atak-civ-sdk-${{ env.RELEASE_TAG }}
          path: atak-civ-sdk-${{ env.RELEASE_TAG }}.zip
          if-no-files-found: error
